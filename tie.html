<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>Silk Tie - Rimmer's Collection</title>
  <link rel="stylesheet" href="css/style.css?v=20250915-5">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="tie-page tie-page-body">
  <a href="#main" class="skip-link">Skip to content</a>
  <!-- Floating WhatsApp for desktop; hidden on tablet/phone by CSS -->
  <a href="https://wa.me/972535455468" target="_blank" rel="noopener" class="floating-whatsapp" aria-label="Chat on WhatsApp">
    <i class="fab fa-whatsapp"></i>
  </a>

  <header class="shrunk" role="banner">
    <div class="header-flex">
      <div class="header-left">
        <a href="contact.html" class="contact-link" style="color: var(--brand-blue); text-decoration: underline; font-weight: bold; font-size: 1.1em; margin-right: 8px; background: none; border: none; padding: 0; border-radius: 0;">Contact</a>
      </div>
      <div class="header-center">
        <a href="index.html"><img src="images/logo.svg" alt="Rimmer's Logo" class="logo"></a>
      </div>
      <div class="header-right">
        <button class="menu-toggle" aria-label="Open menu" aria-expanded="false" aria-controls="mobile-menu">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </button>
      </div>
    </div>
    <nav id="mobile-menu" class="mobile-menu" role="navigation" aria-label="Main menu">
      <a href="index.html">Home</a>
      <a href="contact.html">Contact</a>
    </nav>
  </header>

  <script>
    // Mobile hamburger toggle for tie pages
    (function() {
      var toggle = document.querySelector('.menu-toggle');
      var menu = document.getElementById('mobile-menu');
      if (!toggle || !menu) return;

      function closeMenu() {
        menu.classList.remove('open');
        toggle.classList.remove('open');
        toggle.setAttribute('aria-expanded', 'false');
        try { toggle.blur(); } catch (e) {}
      }
      function openMenu() {
        menu.classList.add('open');
        toggle.classList.add('open');
        toggle.setAttribute('aria-expanded', 'true');
      }
      function toggleMenu() {
        if (menu.classList.contains('open')) closeMenu(); else openMenu();
      }
      toggle.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleMenu();
      });
      document.addEventListener('click', function(e) {
        if (!menu.contains(e.target) && !toggle.contains(e.target)) {
          closeMenu();
        }
      });
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeMenu();
      });
    })();
  </script>

  <main id="main">
  <h1 class="sr-only">Tie details</h1>
  <div class="tie-details">
    <div class="tie-carousel" role="region" aria-roledescription="carousel" aria-label="Tie image gallery">
      <div class="carousel-container">
        <div class="carousel-track" id="carousel-track">
          <!-- Slides injected by JS -->
        </div>
        <!-- Desktop-only navigation arrows (hidden on mobile/tablet via CSS) -->
        <button class="carousel-nav prev" type="button" aria-label="Previous image" title="Previous">
          <i class="fas fa-chevron-left" aria-hidden="true"></i>
        </button>
        <button class="carousel-nav next" type="button" aria-label="Next image" title="Next">
          <i class="fas fa-chevron-right" aria-hidden="true"></i>
        </button>
        <!-- Smartphone-only WhatsApp overlay (positioned bottom-left over the image) -->
        <a href="https://wa.me/972535455468" target="_blank" rel="noopener" class="whatsapp-overlay" aria-label="Chat on WhatsApp">
          <i class="fab fa-whatsapp"></i>
        </a>
  <div id="carousel-numeric" class="carousel-numeric" aria-live="polite" aria-atomic="true">1/1</div>
      </div>
      <p id="carousel-status" class="sr-only" aria-live="polite"></p>
    </div>

    <!-- Info block below the images: brand label (via CSS), title, and price -->
    <div class="tie-info">
      <div class="tie-header">
        <h2 id="tie-title"><span class="title-text">Loading...</span></h2>
        <div id="tie-price" class="tie-price">₪350,00</div>
      </div>
    </div>

    <p class="back-actions">
      <a href="index.html" class="back-link-inline">← Back to Collection</a>
      <a href="https://wa.me/972535455468" target="_blank" rel="noopener" class="whatsapp-inline" aria-label="Chat on WhatsApp">
        <i class="fab fa-whatsapp"></i>
      </a>
    </p>
  </div>
  </main>

  <script>
    // Tiny data-driven tie page: reads ?id=NUMBER and loads images/title from data/ties.json
    const params = new URLSearchParams(location.search);
    const id = params.get('id');

    function renderTie(tie) {
      const titleEl = document.getElementById('tie-title');
      const priceEl = document.getElementById('tie-price');
      const track = document.getElementById('carousel-track');
      const numeric = document.getElementById('carousel-numeric');
      // Title and price
      if (titleEl) {
        const span = titleEl.querySelector('.title-text');
        if (span) span.textContent = tie.title; else titleEl.textContent = tie.title;
      }
      if (priceEl) {
        const raw = (tie.price || '₪350,00').toString().trim();
        const hasSymbol = raw.startsWith('₪');
        const amount = hasSymbol ? raw.slice(1) : raw;
        priceEl.innerHTML = `${hasSymbol ? '<span class="currency" aria-hidden="true">₪</span>' : ''}<span class="amount">${amount}</span>`;
        if (hasSymbol) {
          try { priceEl.setAttribute('aria-label', `NIS ${amount}`); } catch(e) {}
        }
      }

      // Slides
      track.innerHTML = '';
      tie.images.forEach((img, idx) => {
        const slide = document.createElement('div');
        slide.className = 'carousel-slide';
          slide.setAttribute('role', 'group');
          slide.setAttribute('aria-roledescription', 'slide');
          slide.setAttribute('aria-label', `Image ${idx + 1} of ${tie.images.length}`);
          if (idx !== 0) slide.setAttribute('aria-hidden', 'true');
  const image = document.createElement('img');
  image.src = img.src;
  image.loading = (idx === 0 ? 'eager' : 'lazy');
  image.decoding = 'async';
        image.alt = img.alt || tie.title + ' - Image ' + (idx + 1);
        slide.appendChild(image);
        track.appendChild(slide);
      });
      // Reset carousel state
      currentSlideIndex = 0;
      slides = document.querySelectorAll('.carousel-slide');
      if (numeric) {
        numeric.textContent = `1/${slides.length || 1}`;
      }
      updateCarousel();
    }

    fetch('data/ties.json')
      .then(r => r.json())
      .then(data => {
        const tie = data.ties[id];
        if (!tie) throw new Error('Tie not found: ' + id);
        renderTie(tie);
        try { document.title = tie.title + " | Rimmer's"; } catch(e) {}
      })
      .catch(err => {
        document.getElementById('tie-title').textContent = 'Tie not found';
        console.error(err);
      });

    // Carousel logic (robust iOS-friendly with pointer events + live dragging)
    let currentSlideIndex = 0;
    let slides = [];
    const track = document.getElementById('carousel-track');
    const statusEl = document.getElementById('carousel-status');
    const numericEl = document.getElementById('carousel-numeric');
    let isAnimating = false;

    function setTransformByIndex(index) {
      // Use percentage to avoid needing explicit widths
      track.style.transform = `translateX(-${index * 100}%)`;
    }

    function updateA11y(index) {
      if (slides[index]) {
        slides.forEach((s, idx) => s.setAttribute('aria-hidden', idx === index ? 'false' : 'true'));
      }
      const total = slides.length || 1;
      const pos = index + 1;
      if (statusEl) statusEl.textContent = `Image ${pos} of ${total}`;
      if (numericEl) numericEl.textContent = `${pos}/${total}`;
    }

    function updateCarousel() {
      setTransformByIndex(currentSlideIndex);
      updateA11y(currentSlideIndex);
    }

    function gotoSlide(index) {
      if (isAnimating) return;
      const total = slides.length;
      if (!total) return;
      // wrap-around
      if (index >= total) index = 0;
      if (index < 0) index = total - 1;
      isAnimating = true;
      track.style.transition = 'transform 300ms ease';
      currentSlideIndex = index;
      setTransformByIndex(currentSlideIndex);
    }

    track.addEventListener('transitionend', function(ev) {
      if (ev.propertyName !== 'transform') return;
      isAnimating = false;
      // ensure a11y state sync after animation
      updateA11y(currentSlideIndex);
    });

    function changeSlide(direction) {
      gotoSlide(currentSlideIndex + direction);
    }

    function currentSlide(index) {
      gotoSlide(index - 1);
    }

    // Pointer Events with touch fallback for reliable swiping on iOS/Chrome
    let pointerId = null;
    let startX = 0;
    let deltaX = 0;
    let dragging = false;
    const SWIPE_THRESHOLD = 0.18; // as fraction of slide width (~18%)
    const EDGE_RESISTANCE = 0.35; // resistance factor near edges

    function onPointerDown(e) {
      if (isAnimating) return;
      dragging = true;
      deltaX = 0;
      pointerId = e.pointerId;
      startX = e.clientX;
      track.style.transition = 'none';
      track.setPointerCapture && track.setPointerCapture(pointerId);
      track.style.willChange = 'transform';
    }

    function onPointerMove(e) {
      if (!dragging) return;
      const x = e.clientX;
      deltaX = x - startX;
      const trackWidth = track.clientWidth || 1;
      let percent = (deltaX / trackWidth) * 100; // positive when dragging right
      // Apply resistance at edges
      if ((currentSlideIndex === 0 && percent > 0) || (currentSlideIndex === slides.length - 1 && percent < 0)) {
        percent *= EDGE_RESISTANCE;
      }
      track.style.transform = `translateX(calc(${-currentSlideIndex * 100}% + ${percent}%))`;
    }

    function onPointerUpOrCancel() {
      if (!dragging) return;
      dragging = false;
      track.style.willChange = 'auto';
      const trackWidth = track.clientWidth || 1;
      const traveled = Math.abs(deltaX) / trackWidth;
      track.style.transition = 'transform 300ms ease';
      if (traveled > SWIPE_THRESHOLD) {
        const dir = deltaX < 0 ? 1 : -1; // left drag moves to next (dir=1)
        gotoSlide(currentSlideIndex + dir);
      } else {
        // snap back
        setTransformByIndex(currentSlideIndex);
      }
      pointerId = null;
      deltaX = 0;
    }

    // Attach Pointer Events if available
    if (window.PointerEvent) {
      track.addEventListener('pointerdown', onPointerDown);
      track.addEventListener('pointermove', onPointerMove);
      track.addEventListener('pointerup', onPointerUpOrCancel);
      track.addEventListener('pointercancel', onPointerUpOrCancel);
    } else {
      // Fallback to touch events with non-passive move
      let touchStartX = 0;
      let lastX = 0;
      let locked = false;
      const LOCK_THRESHOLD = 8; // px to lock horizontal
      track.addEventListener('touchstart', (e) => {
        if (isAnimating) return;
        const t = e.touches[0];
        touchStartX = t.clientX;
        lastX = touchStartX;
        dragging = true;
        locked = false;
        track.style.transition = 'none';
        track.style.willChange = 'transform';
      }, { passive: true });
      track.addEventListener('touchmove', (e) => {
        if (!dragging) return;
        const t = e.touches[0];
        const x = t.clientX;
        const dx = x - touchStartX;
        lastX = x;
        if (!locked && Math.abs(dx) > LOCK_THRESHOLD && e.cancelable) {
          // prevent page scroll once horizontal intent is clear
          e.preventDefault();
          locked = true;
        }
        const trackWidth = track.clientWidth || 1;
        let percent = (dx / trackWidth) * 100;
        if ((currentSlideIndex === 0 && percent > 0) || (currentSlideIndex === slides.length - 1 && percent < 0)) {
          percent *= EDGE_RESISTANCE;
        }
        track.style.transform = `translateX(calc(${-currentSlideIndex * 100}% + ${percent}%))`;
      }, { passive: false });
      track.addEventListener('touchend', (e) => {
        if (!dragging) return;
        dragging = false;
        track.style.willChange = 'auto';
        const endX = (e.changedTouches && e.changedTouches[0] ? e.changedTouches[0].clientX : lastX);
        const traveled = Math.abs(endX - touchStartX) / (track.clientWidth || 1);
        track.style.transition = 'transform 300ms ease';
        if (traveled > 0.18) {
          const dir = (endX - touchStartX) < 0 ? 1 : -1;
          gotoSlide(currentSlideIndex + dir);
        } else {
          setTransformByIndex(currentSlideIndex);
        }
      }, { passive: true });
      track.addEventListener('touchcancel', () => {
        dragging = false;
        track.style.willChange = 'auto';
        track.style.transition = 'transform 300ms ease';
        setTransformByIndex(currentSlideIndex);
      }, { passive: true });
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') changeSlide(-1);
      else if (e.key === 'ArrowRight') changeSlide(1);
    });

    // Click navigation (desktop arrows)
    (function(){
      var prevBtn = document.querySelector('.carousel-nav.prev');
      var nextBtn = document.querySelector('.carousel-nav.next');
      if (prevBtn) prevBtn.addEventListener('click', function(){ changeSlide(-1); });
      if (nextBtn) nextBtn.addEventListener('click', function(){ changeSlide(1); });
    })();
  </script>
  <footer class="site-footer" role="contentinfo" aria-label="Site footer">
    <div class="footer-inner">
      <div class="footer-left">
        <a href="index.html" class="footer-logo" aria-label="Rimmer's Home">
          <img src="images/logo.svg" alt="Rimmer's Logo" />
        </a>
      </div>
      <div class="footer-center">
        <p>Website designed by Daniel Rimmer · <a href="accessibility.html">Accessibility</a></p>
      </div>
      <div class="footer-right">
        <div class="footer-contact" aria-label="Contact information">
          <a class="footer-phone" href="tel:+9723191655" aria-label="Call us at plus nine seven two three one nine one six five five">CALL US +972 319 1655</a>
          <a class="footer-email" href="mailto:shop.rimmers@gmail.com" aria-label="Email shop dot rimmers at gmail dot com">Email: shop.rimmers@gmail.com</a>
        </div>
      </div>
    </div>
  </footer>
</body>
</html>
